import { compressItems, CompressProgress, CompressResult, CompressTaskController } from '../utils/Compress';
import { hilog } from '@kit.PerformanceAnalysisKit';
import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { TestFileGenerator } from '../utils/TestFileGenerator';
import promptAction from '@ohos.promptAction';

const DOMAIN = 0x0000;

@Entry
@Component
struct CompressTestPage {
  private context = getContext(this) as common.UIAbilityContext;
  private filesDir: string = '';
  private compressController: CompressTaskController | null = null;
  
  // æ–‡ä»¶åˆ›å»ºç›¸å…³çŠ¶æ€
  @State createProgress: number = 0;
  @State isCreatingFiles: boolean = false;
  @State createStatusText: string = 'æœªåˆ›å»º';
  
  // å‹ç¼©ç›¸å…³çŠ¶æ€
  @State compressProgress: number = 0;
  @State statusText: string = 'è¯·é€‰æ‹©æ“ä½œ';
  @State logText: string = '';
  @State isCompressing: boolean = false;
  @State compressionRatio: number = 0;
  @State originalSize: number = 0;
  @State compressedSize: number = 0;
  @State fileCount: number = 0;
  
  // è·¯å¾„æ˜¾ç¤º
  @State inputPathDisplay: string = 'æœªé€‰æ‹©';
  @State outputPathDisplay: string = 'æœªç”Ÿæˆ';
  
  // å·²åˆ›å»ºçš„æ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºåç»­å‹ç¼©ï¼‰
  private createdFiles: Map<string, string[]> = new Map();

  aboutToAppear() {
    this.filesDir = this.context.filesDir;
    this.addLog(`âœ“ åº”ç”¨ç›®å½•: ${this.filesDir}`);
    this.addLog(`ğŸ’¡ æ“ä½œæµç¨‹: å…ˆåˆ›å»ºæµ‹è¯•æ–‡ä»¶ â†’ å†é€‰æ‹©å‹ç¼©æ“ä½œ`);
  }

  private addLog(message: string) {
    const time = new Date().toLocaleTimeString();
    this.logText = `[${time}] ${message}\n${this.logText}`;
    hilog.info(DOMAIN, 'CompressTest', message);
  }
  
  // æ­¥éª¤1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶
  private async createTestFiles(mode: 'single' | 'multi' | 'folder') {
    if (this.isCreatingFiles) return;
    
    this.isCreatingFiles = true;
    this.createProgress = 0;
    this.createStatusText = 'åˆ›å»ºä¸­...';
    
    const modeText = mode === 'single' ? 'å•æ–‡ä»¶' : mode === 'multi' ? 'å¤šæ–‡ä»¶' : 'æ–‡ä»¶å¤¹';
    this.addLog('========================================');
    this.addLog(`ğŸ“ åˆ›å»º ${modeText} æµ‹è¯•æ–‡ä»¶`);
    this.addLog('========================================');
    
    try {
      let inputPaths: string[] = [];
      let totalSteps = 0;
      let currentStep = 0;
      
      if (mode === 'single') {
        totalSteps = 1;
        const singleFile = `${this.filesDir}/compress_test_5mb.txt`;
        this.addLog(`   åˆ›å»º: compress_test_5mb.txt (5MB)`);
        this.createProgress = 20;
        
        await TestFileGenerator.createTestTextFileWithSize(singleFile, 5 * 1024);
        this.createProgress = 100;
        
        inputPaths = [singleFile];
        this.inputPathDisplay = singleFile;
        this.addLog(`   âœ“ å•æ–‡ä»¶åˆ›å»ºå®Œæˆ`);
      } else if (mode === 'multi') {
        totalSteps = 8;
        this.addLog(`   åˆ›å»º: å¤šä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å° 15MB+`);
        
        const file1 = `${this.filesDir}/compress_file1.txt`;
        this.createProgress = 5;
        this.addLog(`   åˆ›å»ºfile1 (3MB)...`);
        await TestFileGenerator.createTestTextFileWithSize(file1, 3 * 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const file2 = `${this.filesDir}/compress_file2.txt`;
        this.addLog(`   åˆ›å»ºfile2 (4MB)...`);
        await TestFileGenerator.createTestTextFileWithSize(file2, 4 * 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const file3 = `${this.filesDir}/compress_file3.txt`;
        this.addLog(`   åˆ›å»ºfile3 (3MB)...`);
        await TestFileGenerator.createTestTextFileWithSize(file3, 3 * 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const compressDir1 = `${this.filesDir}/compress_dir1`;
        await TestFileGenerator.createDirectory(compressDir1);
        this.addLog(`   åˆ›å»ºç›®å½•compress_dir1...`);
        currentStep++;
        
        await TestFileGenerator.createTestTextFileWithSize(`${compressDir1}/data_a.txt`, 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        await TestFileGenerator.createTestTextFileWithSize(`${compressDir1}/data_b.txt`, 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const compressDir2 = `${this.filesDir}/compress_dir2`;
        await TestFileGenerator.createDirectory(compressDir2);
        this.addLog(`   åˆ›å»ºç›®å½•compress_dir2...`);
        await TestFileGenerator.createTestTextFileWithSize(`${compressDir2}/info.txt`, 2 * 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const subdir = `${compressDir2}/subdir`;
        await TestFileGenerator.createDirectory(subdir);
        await TestFileGenerator.createTestTextFileWithSize(`${subdir}/nested_data.txt`, 1024);
        currentStep++;
        this.createProgress = 100;
        
        inputPaths = [file1, file2, file3, compressDir1, compressDir2];
        this.inputPathDisplay = `compress_file1.txt, compress_file2.txt, compress_file3.txt + 2ä¸ªç›®å½•`;
        this.addLog(`   âœ“ å¤šæ–‡ä»¶åˆ›å»ºå®Œæˆ: 10MB + 5MB`);
      } else {
        totalSteps = 7;
        this.addLog(`   åˆ›å»º: æµ‹è¯•æ–‡ä»¶å¤¹ 10MB+`);
        
        const testFolder = `${this.filesDir}/test_folder`;
        await TestFileGenerator.createDirectory(testFolder);
        this.createProgress = 10;
        
        this.addLog(`   åˆ›å»ºdoc1 (2MB)...`);
        await TestFileGenerator.createTestTextFileWithSize(`${testFolder}/doc1.txt`, 2 * 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        this.addLog(`   åˆ›å»ºdoc2 (3MB)...`);
        await TestFileGenerator.createTestTextFileWithSize(`${testFolder}/doc2.txt`, 3 * 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        this.addLog(`   åˆ›å»ºdoc3 (2MB)...`);
        await TestFileGenerator.createTestTextFileWithSize(`${testFolder}/doc3.txt`, 2 * 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const subfolder1 = `${testFolder}/subfolder1`;
        await TestFileGenerator.createDirectory(subfolder1);
        await TestFileGenerator.createTestTextFileWithSize(`${subfolder1}/file_a.txt`, 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        await TestFileGenerator.createTestTextFileWithSize(`${subfolder1}/file_b.txt`, 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const subfolder2 = `${testFolder}/subfolder2`;
        await TestFileGenerator.createDirectory(subfolder2);
        await TestFileGenerator.createTestTextFileWithSize(`${subfolder2}/data.txt`, 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const deepFolder = `${subfolder2}/deep`;
        await TestFileGenerator.createDirectory(deepFolder);
        await TestFileGenerator.createTestTextFileWithSize(`${deepFolder}/nested.txt`, 1024);
        currentStep++;
        this.createProgress = 100;
        
        inputPaths = [testFolder];
        this.inputPathDisplay = testFolder;
        this.addLog(`   âœ“ æ–‡ä»¶å¤¹åˆ›å»ºå®Œæˆ`);
      }
      
      // ä¿å­˜åˆ›å»ºçš„æ–‡ä»¶è·¯å¾„
      this.createdFiles.set(mode, inputPaths);
      this.createStatusText = `âœ… ${modeText}å·²åˆ›å»º`;
      
      this.addLog(`âœ… ${modeText} æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼`);
      this.addLog('========================================');
      
      promptAction.showToast({ 
        message: `${modeText}åˆ›å»ºå®Œæˆï¼`, 
        duration: 2000 
      });
      
    } catch (error) {
      this.addLog(`âŒ åˆ›å»ºå¤±è´¥: ${JSON.stringify(error)}`);
      this.createStatusText = 'åˆ›å»ºå¤±è´¥';
    } finally {
      this.isCreatingFiles = false;
      this.createProgress = 0;
    }
  }
  
  // æ­¥éª¤2: å‹ç¼©æ–‡ä»¶
  private async compressFiles(format: '7z' | 'zip', mode: 'single' | 'multi' | 'folder') {
    if (this.isCompressing) return;
    
    // æ£€æŸ¥æ˜¯å¦å·²åˆ›å»ºæ–‡ä»¶
    const inputPaths = this.createdFiles.get(mode);
    if (!inputPaths || inputPaths.length === 0) {
      promptAction.showToast({ 
        message: 'è¯·å…ˆåˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼', 
        duration: 2000 
      });
      this.addLog(`âš ï¸  è¯·å…ˆç‚¹å‡»"åˆ›å»ºæ–‡ä»¶"æŒ‰é’®`);
      return;
    }
    
    this.isCompressing = true;
    this.compressProgress = 0;
    this.compressionRatio = 0;
    this.originalSize = 0;
    this.compressedSize = 0;
    this.fileCount = 0;
    
    const modeText = mode === 'single' ? 'å•æ–‡ä»¶' : mode === 'multi' ? 'å¤šæ–‡ä»¶' : 'æ–‡ä»¶å¤¹';
    const outputFileName = `${mode}_compressed.${format}`;
    const outputPath = `${this.filesDir}/${outputFileName}`;
    this.outputPathDisplay = outputPath;
    
    this.addLog('========================================');
    this.addLog(`ğŸ—œï¸  å‹ç¼© ${modeText}.${format}`);
    this.addLog('========================================');
    this.statusText = `å‹ç¼©ä¸­...`;
    
    try {
      this.compressController = compressItems(
        inputPaths,
        outputPath,
        { format: format, compressionLevel: 5 },
        (prog: CompressProgress) => {
          this.compressProgress = prog.percentage;
          this.statusText = `å‹ç¼©ä¸­ ${prog.percentage}%`;
          if (prog.percentage % 20 === 0 && prog.percentage > 0) {
            this.addLog(`   è¿›åº¦: ${prog.percentage}%`);
          }
        }
      );
      
      const result = await this.compressController.promise;
      this.compressController = null;
      
      if (result.success) {
        this.originalSize = result.originalSize || 0;
        this.compressedSize = result.compressedSize || 0;
        this.compressionRatio = result.compressionRatio || 0;
        this.fileCount = result.fileCount || 0;
        
        this.addLog('========================================');
        this.addLog(`âœ… å‹ç¼©æˆåŠŸï¼`);
        this.addLog(`   æ ¼å¼: ${result.format}`);
        this.addLog(`   æ–‡ä»¶æ•°: ${this.fileCount}`);
        this.addLog(`   åŸå§‹: ${this.formatBytes(this.originalSize)}`);
        this.addLog(`   å‹ç¼©å: ${this.formatBytes(this.compressedSize)}`);
        this.addLog(`   å‹ç¼©ç‡: ${this.compressionRatio.toFixed(1)}%`);
        this.addLog('========================================');
        this.statusText = `âœ… å‹ç¼©æˆåŠŸ`;
        
        promptAction.showToast({ 
          message: `å‹ç¼©æˆåŠŸï¼`, 
          duration: 2000 
        });
      } else {
        this.addLog(`âŒ å‹ç¼©å¤±è´¥: ${result.message}`);
        this.statusText = 'å‹ç¼©å¤±è´¥';
      }
      
    } catch (error) {
      this.addLog(`âŒ å¼‚å¸¸: ${JSON.stringify(error)}`);
      this.statusText = 'å‹ç¼©å¤±è´¥';
    } finally {
      this.isCompressing = false;
      this.compressProgress = 0;
    }
  }
  
  // å–æ¶ˆå‹ç¼©
  private cancelCompress() {
    if (!this.compressController) {
      this.addLog('âš ï¸  æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„å‹ç¼©ä»»åŠ¡');
      return;
    }
    
    this.addLog(`ğŸ›‘ æ­£åœ¨å–æ¶ˆå‹ç¼©...`);
    const success = this.compressController.cancel();
    
    if (success) {
      this.addLog('âœ… å–æ¶ˆæˆåŠŸ');
      this.statusText = 'å·²å–æ¶ˆ';
    } else {
      this.addLog('âš ï¸  å–æ¶ˆå¤±è´¥');
    }
  }
  
  private formatBytes(bytes: number): string {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
  }

  build() {
    Scroll() {
      Column() {
        // è¿”å›æŒ‰é’®
        Button('â† è¿”å›ä¸»èœå•')
          .fontSize(14)
          .backgroundColor('#E0E0E0')
          .fontColor('#333333')
          .height(40)
          .margin({ bottom: 20 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/MainMenu' }).catch((err: Error) => {
              this.addLog(`å¯¼èˆªå¤±è´¥: ${err.message}`);
            });
          })
        
        // æ ‡é¢˜
        Text('å‹ç¼©æµ‹è¯•')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 5 })
        
        Text('æ­¥éª¤ï¼šâ‘ åˆ›å»ºæ–‡ä»¶ â†’ â‘¡å‹ç¼©æ–‡ä»¶')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ bottom: 20 })

        // ==================== è·¯å¾„ä¿¡æ¯æ˜¾ç¤º ====================
        Column() {
          Text('è·¯å¾„ä¿¡æ¯')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          // è¾“å…¥è·¯å¾„
          Column() {
            Row() {
              Text('è¾“å…¥:')
                .fontSize(13)
                .fontWeight(FontWeight.Bold)
                .fontColor('#666666')
                .width(50)
              
              Text(this.inputPathDisplay)
                .fontSize(12)
                .fontFamily('monospace')
                .fontColor('#333333')
                .layoutWeight(1)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .margin({ bottom: 8 })
            .alignItems(VerticalAlign.Top)
            
            // è¾“å‡ºè·¯å¾„
            Row() {
              Text('è¾“å‡º:')
                .fontSize(13)
                .fontWeight(FontWeight.Bold)
                .fontColor('#666666')
                .width(50)
              
              Text(this.outputPathDisplay)
                .fontSize(12)
                .fontFamily('monospace')
                .fontColor('#333333')
                .layoutWeight(1)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .alignItems(VerticalAlign.Top)
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#FFFFFF')
          .border({ width: 1, color: '#DDDDDD', radius: 5 })
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#F9F9F9')
        .border({ width: 1, color: '#CCCCCC', radius: 8 })
        .margin({ bottom: 20 })

        // ==================== æ­¥éª¤1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶ ====================
        Column() {
          Text('æ­¥éª¤1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Text('åˆ›å»ºä¸åŒç±»å‹çš„æµ‹è¯•æ–‡ä»¶ï¼ˆéœ€è¦å‡ ç§’æ—¶é—´ï¼‰')
            .fontSize(13)
            .fontColor('#666666')
            .margin({ bottom: 15 })
            .alignSelf(ItemAlign.Start)
          
          // åˆ›å»ºæŒ‰é’®ç»„
          Row() {
            Button('åˆ›å»ºå•æ–‡ä»¶(5MB)')
              .layoutWeight(1)
              .height(50)
              .fontSize(14)
              .backgroundColor('#4CAF50')
              .enabled(!this.isCreatingFiles)
              .onClick(() => {
                this.createTestFiles('single');
              })
            
            Button('åˆ›å»ºå¤šæ–‡ä»¶(15MB)')
              .layoutWeight(1)
              .height(50)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#2196F3')
              .enabled(!this.isCreatingFiles)
              .onClick(() => {
                this.createTestFiles('multi');
              })
            
            Button('åˆ›å»ºæ–‡ä»¶å¤¹(10MB)')
              .layoutWeight(1)
              .height(50)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#FF9800')
              .enabled(!this.isCreatingFiles)
              .onClick(() => {
                this.createTestFiles('folder');
              })
          }
          .width('100%')
          .margin({ bottom: 15 })
          
          // æ–‡ä»¶åˆ›å»ºè¿›åº¦æ¡
          if (this.isCreatingFiles) {
            Column() {
              Text('æ–‡ä»¶åˆ›å»ºè¿›åº¦')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 8 })
                .alignSelf(ItemAlign.Start)
              
              Progress({ value: this.createProgress, total: 100, type: ProgressType.Linear })
                .width('100%')
                .color('#4CAF50')
                .margin({ bottom: 8 })
              
              Text(`${this.createProgress}% - æ­£åœ¨åˆ›å»ºæ–‡ä»¶...`)
                .fontSize(13)
                .fontColor('#4CAF50')
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#E8F5E9')
            .border({ width: 1, color: '#4CAF50', radius: 5 })
            .margin({ bottom: 15 })
          }
          
          // åˆ›å»ºçŠ¶æ€
          Text(`çŠ¶æ€: ${this.createStatusText}`)
            .fontSize(14)
            .padding(10)
            .width('100%')
            .backgroundColor('#F5F5F5')
            .border({ width: 1, color: '#DDDDDD', radius: 5 })
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#F0F8FF')
        .border({ width: 2, color: '#2196F3', radius: 10 })
        .margin({ bottom: 25 })

        // ==================== æ­¥éª¤2: å‹ç¼©æµ‹è¯• ====================
        Column() {
          Text('æ­¥éª¤2: å‹ç¼©æ–‡ä»¶')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Text('é€‰æ‹©æ ¼å¼å‹ç¼©å·²åˆ›å»ºçš„æ–‡ä»¶')
            .fontSize(13)
            .fontColor('#666666')
            .margin({ bottom: 15 })
            .alignSelf(ItemAlign.Start)
          
          // Zip æ ¼å¼
          Text('ğŸ“¦ Zip æ ¼å¼')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('å‹ç¼©å•æ–‡ä»¶.zip')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .backgroundColor('#00BCD4')
              .enabled(!this.isCompressing)
              .onClick(() => {
                this.compressFiles('zip', 'single');
              })
            
            Button('å‹ç¼©å¤šæ–‡ä»¶.zip')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#0097A7')
              .enabled(!this.isCompressing)
              .onClick(() => {
                this.compressFiles('zip', 'multi');
              })
            
            Button('å‹ç¼©æ–‡ä»¶å¤¹.zip')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#00838F')
              .enabled(!this.isCompressing)
              .onClick(() => {
                this.compressFiles('zip', 'folder');
              })
          }
          .width('100%')
          .margin({ bottom: 15 })
          
          // 7z æ ¼å¼
          Text('ğŸ“¦ 7z æ ¼å¼')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('å‹ç¼©å•æ–‡ä»¶.7z')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .backgroundColor('#9C27B0')
              .enabled(!this.isCompressing)
              .onClick(() => {
                this.compressFiles('7z', 'single');
              })
            
            Button('å‹ç¼©å¤šæ–‡ä»¶.7z')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#673AB7')
              .enabled(!this.isCompressing)
              .onClick(() => {
                this.compressFiles('7z', 'multi');
              })
            
            Button('å‹ç¼©æ–‡ä»¶å¤¹.7z')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#4A148C')
              .enabled(!this.isCompressing)
              .onClick(() => {
                this.compressFiles('7z', 'folder');
              })
          }
          .width('100%')
          .margin({ bottom: 15 })
          
          // å‹ç¼©è¿›åº¦æ¡
          if (this.isCompressing) {
            Column() {
              Row() {
                Text('å‹ç¼©è¿›åº¦')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .layoutWeight(1)
                
                Button('ğŸ›‘ å–æ¶ˆ')
                  .height(35)
                  .fontSize(14)
                  .backgroundColor('#F44336')
                  .onClick(() => {
                    this.cancelCompress();
                  })
              }
              .width('100%')
              .margin({ bottom: 10 })
              
              Progress({ value: this.compressProgress, total: 100, type: ProgressType.Linear })
                .width('100%')
                .color('#FF9800')
                .margin({ bottom: 10 })
              
              Text(`${this.compressProgress}% - ${this.statusText}`)
                .fontSize(14)
                .fontColor('#FF9800')
            }
            .width('100%')
            .padding(15)
            .backgroundColor('#FFF3E0')
            .border({ width: 1, color: '#FF9800', radius: 8 })
            .margin({ bottom: 15 })
          }
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#E8F5E9')
        .border({ width: 2, color: '#4CAF50', radius: 10 })
        .margin({ bottom: 25 })

        // ==================== å‹ç¼©ç»Ÿè®¡ ====================
        if (this.compressionRatio > 0) {
          Column() {
            Text('å‹ç¼©ç»Ÿè®¡')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 15 })
              .alignSelf(ItemAlign.Start)
            
            Row() {
              Column() {
                Text('æ–‡ä»¶æ•°')
                  .fontSize(12)
                  .fontColor('#666666')
                Text(`${this.fileCount}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 5 })
              }
              .layoutWeight(1)
              
              Column() {
                Text('åŸå§‹å¤§å°')
                  .fontSize(12)
                  .fontColor('#666666')
                Text(this.formatBytes(this.originalSize))
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 5 })
              }
              .layoutWeight(1)
              
              Text('â†’')
                .fontSize(20)
                .fontColor('#999999')
              
              Column() {
                Text('å‹ç¼©å')
                  .fontSize(12)
                  .fontColor('#666666')
                Text(this.formatBytes(this.compressedSize))
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#4CAF50')
                  .margin({ top: 5 })
              }
              .layoutWeight(1)
              
              Column() {
                Text('å‹ç¼©ç‡')
                  .fontSize(12)
                  .fontColor('#666666')
                Text(`${this.compressionRatio.toFixed(1)}%`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FF9800')
                  .margin({ top: 5 })
              }
              .layoutWeight(1)
            }
            .width('100%')
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#E8F5E9')
          .border({ width: 1, color: '#4CAF50', radius: 8 })
          .margin({ bottom: 20 })
        }

        // ==================== æ—¥å¿— ====================
        Text('æ“ä½œæ—¥å¿—')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 10 })
          .alignSelf(ItemAlign.Start)

        Scroll() {
          Text(this.logText || 'ç­‰å¾…æ“ä½œ...')
            .width('100%')
            .fontSize(12)
            .fontFamily('monospace')
            .textAlign(TextAlign.Start)
            .padding(10)
        }
        .width('100%')
        .height(250)
        .backgroundColor('#F5F5F5')
        .border({ width: 1, color: '#DDDDDD', radius: 8 })
      }
      .width('100%')
      .padding(20)
    }
    .width('100%')
    .height('100%')
  }
}
