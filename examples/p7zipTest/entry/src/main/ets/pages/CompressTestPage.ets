import { compressItems, CompressProgress, CompressResult, CompressTaskController } from '../utils/Compress';
import { hilog } from '@kit.PerformanceAnalysisKit';
import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { TestFileGenerator } from '../utils/TestFileGenerator';
import promptAction from '@ohos.promptAction';

const DOMAIN = 0x0000;

@Entry
@Component
struct CompressTestPage {
  private context = getContext(this) as common.UIAbilityContext;
  private filesDir: string = '';
  private compressController: CompressTaskController | null = null;
  
  @State progress: number = 0;
  @State statusText: string = 'è¯·é€‰æ‹©æ“ä½œ';
  @State logText: string = '';
  @State isRunning: boolean = false;
  @State compressionRatio: number = 0;
  @State originalSize: number = 0;
  @State compressedSize: number = 0;
  @State fileCount: number = 0;
  @State currentInputPath: string = 'æœªé€‰æ‹©';
  @State currentOutputPath: string = 'æœªé€‰æ‹©';

  aboutToAppear() {
    this.filesDir = this.context.filesDir;
    this.addLog(`âœ“ åº”ç”¨ç›®å½•: ${this.filesDir}`);
    this.addLog(`ğŸ’¡ æ”¯æŒ: å•æ–‡ä»¶/å¤šæ–‡ä»¶/æ–‡ä»¶å¤¹/ç©ºæ–‡ä»¶å¤¹å‹ç¼©æµ‹è¯•`);
  }

  private addLog(message: string) {
    const time = new Date().toLocaleTimeString();
    this.logText = `[${time}] ${message}\n${this.logText}`;
    hilog.info(DOMAIN, 'CompressTest', message);
  }
  
  // åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¹¶å‹ç¼©
  private async createAndCompress(format: '7z' | 'zip', mode: 'single' | 'multi' | 'folder') {
    if (this.isRunning) return;
    
    this.isRunning = true;
    this.progress = 0;
    this.compressionRatio = 0;
    this.originalSize = 0;
    this.compressedSize = 0;
    this.fileCount = 0;
    this.logText = '';
    
    const modeText = mode === 'single' ? 'å•æ–‡ä»¶' : mode === 'multi' ? 'å¤šæ–‡ä»¶' : 'æ–‡ä»¶å¤¹';
    const outputFileName = `${mode}_compressed.${format}`;
    const outputPath = `${this.filesDir}/${outputFileName}`;
    
    // æ›´æ–°æ˜¾ç¤ºè·¯å¾„
    this.currentOutputPath = outputPath;
    
    this.addLog('========================================');
    this.addLog(`ğŸ—œï¸ å¼€å§‹ ${modeText}.${format} å‹ç¼©æµ‹è¯•`);
    this.addLog('========================================');
    this.statusText = `åˆ›å»ºå¹¶å‹ç¼© ${modeText}.${format} ä¸­...`;
    
    try {
      // ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼ˆè‡³å°‘5MBï¼‰
      this.addLog('ğŸ“ æ­¥éª¤1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼ˆ5MB+ï¼‰...');
      
      let inputPaths: string[] = [];
      
      if (mode === 'single') {
        // å•æ–‡ä»¶æ¨¡å¼ï¼šåˆ›å»ºä¸€ä¸ª 5MB çš„æ–‡ä»¶
        const singleFile = `${this.filesDir}/compress_test_5mb.bin`;
        this.addLog(`   åˆ›å»º: compress_test_5mb.bin (5MB)`);
        await TestFileGenerator.createTestBinaryFile(singleFile, 5 * 1024); // 5MB
        inputPaths = [singleFile];
        this.currentInputPath = singleFile;
        this.addLog(`   âœ“ å•æ–‡ä»¶åˆ›å»ºå®Œæˆ: 5MB`);
      } else if (mode === 'multi') {
        // å¤šæ–‡ä»¶æ¨¡å¼ï¼šåˆ›å»ºå¤šä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å°è¶…è¿‡5MB
        this.addLog(`   åˆ›å»º: å¤šä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å° 15MB+`);
        
        // åˆ›å»º3ä¸ªå¤§æ–‡ä»¶
        const file1 = `${this.filesDir}/compress_file1.bin`;
        await TestFileGenerator.createTestBinaryFile(file1, 3 * 1024); // 3MB
        
        const file2 = `${this.filesDir}/compress_file2.bin`;
        await TestFileGenerator.createTestBinaryFile(file2, 4 * 1024); // 4MB
        
        const file3 = `${this.filesDir}/compress_file3.bin`;
        await TestFileGenerator.createTestBinaryFile(file3, 3 * 1024); // 3MB
        
        // åˆ›å»ºæ–‡ä»¶å¤¹ç»“æ„
        const compressDir1 = `${this.filesDir}/compress_dir1`;
        await TestFileGenerator.createDirectory(compressDir1);
        await TestFileGenerator.createTestBinaryFile(`${compressDir1}/data_a.bin`, 1024); // 1MB
        await TestFileGenerator.createTestBinaryFile(`${compressDir1}/data_b.bin`, 1024); // 1MB
        
        const compressDir2 = `${this.filesDir}/compress_dir2`;
        await TestFileGenerator.createDirectory(compressDir2);
        await TestFileGenerator.createTestBinaryFile(`${compressDir2}/info.bin`, 2 * 1024); // 2MB
        
        const subdir = `${compressDir2}/subdir`;
        await TestFileGenerator.createDirectory(subdir);
        await TestFileGenerator.createTestBinaryFile(`${subdir}/nested_data.bin`, 1024); // 1MB
        
        inputPaths = [file1, file2, file3, compressDir1, compressDir2];
        this.currentInputPath = `compress_file1.bin, compress_file2.bin, ... (å…±5é¡¹)`;
        this.addLog(`   âœ“ å¤šæ–‡ä»¶åˆ›å»ºå®Œæˆ: 3ä¸ªæ–‡ä»¶(10MB) + 2ä¸ªæ–‡ä»¶å¤¹(5MB)`);
      } else {
        // æ–‡ä»¶å¤¹æ¨¡å¼ï¼šåˆ›å»ºä¸€ä¸ªåŒ…å«å¤šä¸ªæ–‡ä»¶çš„æ–‡ä»¶å¤¹
        this.addLog(`   åˆ›å»º: æµ‹è¯•æ–‡ä»¶å¤¹ï¼ŒåŒ…å« 10MB+ æ–‡ä»¶`);
        
        const testFolder = `${this.filesDir}/test_folder`;
        await TestFileGenerator.createDirectory(testFolder);
        
        // åœ¨æ–‡ä»¶å¤¹ä¸­åˆ›å»ºå¤šä¸ªæ–‡ä»¶
        await TestFileGenerator.createTestBinaryFile(`${testFolder}/doc1.bin`, 2 * 1024); // 2MB
        await TestFileGenerator.createTestBinaryFile(`${testFolder}/doc2.bin`, 3 * 1024); // 3MB
        await TestFileGenerator.createTestBinaryFile(`${testFolder}/doc3.bin`, 2 * 1024); // 2MB
        
        // åˆ›å»ºå­æ–‡ä»¶å¤¹
        const subfolder1 = `${testFolder}/subfolder1`;
        await TestFileGenerator.createDirectory(subfolder1);
        await TestFileGenerator.createTestBinaryFile(`${subfolder1}/file_a.bin`, 1024); // 1MB
        await TestFileGenerator.createTestBinaryFile(`${subfolder1}/file_b.bin`, 1024); // 1MB
        
        const subfolder2 = `${testFolder}/subfolder2`;
        await TestFileGenerator.createDirectory(subfolder2);
        await TestFileGenerator.createTestBinaryFile(`${subfolder2}/data.bin`, 1024); // 1MB
        
        // æ·±å±‚åµŒå¥—
        const deepFolder = `${subfolder2}/deep`;
        await TestFileGenerator.createDirectory(deepFolder);
        await TestFileGenerator.createTestBinaryFile(`${deepFolder}/nested.bin`, 1024); // 1MB
        
        inputPaths = [testFolder];
        this.currentInputPath = testFolder;
        this.addLog(`   âœ“ æ–‡ä»¶å¤¹åˆ›å»ºå®Œæˆ: test_folder (10MB+, å«å­æ–‡ä»¶å¤¹)`);
      }
      
      this.addLog(`âœ… æµ‹è¯•æ–‡ä»¶åˆ›å»ºæˆåŠŸ`);
      
      // ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œå‹ç¼©
      this.addLog(`ğŸ“¦ æ­¥éª¤2: å‹ç¼©ä¸º ${format} æ ¼å¼...`);
      this.addLog(`   è¾“å‡º: ${outputFileName}`);
      
      // è°ƒç”¨å‹ç¼©æ¥å£
      this.compressController = compressItems(
        inputPaths,
        outputPath,
        { format: format, compressionLevel: 5 },
        (prog: CompressProgress) => {
          this.progress = prog.percentage;
          this.statusText = `å‹ç¼©ä¸­ ${prog.percentage}%`;
          if (prog.percentage % 20 === 0 && prog.percentage > 0) {
            this.addLog(`   å‹ç¼©è¿›åº¦: ${prog.percentage}%`);
          }
        }
      );
      
      const result = await this.compressController.promise;
      this.compressController = null;
      
      if (result.success) {
        this.originalSize = result.originalSize || 0;
        this.compressedSize = result.compressedSize || 0;
        this.compressionRatio = result.compressionRatio || 0;
        this.fileCount = result.fileCount || 0;
        
        this.addLog('========================================');
        this.addLog(`âœ… ${modeText}.${format} å‹ç¼©æˆåŠŸï¼`);
        this.addLog(`   æ ¼å¼: ${result.format}`);
        this.addLog(`   æ–‡ä»¶æ•°: ${this.fileCount}`);
        this.addLog(`   åŸå§‹å¤§å°: ${this.formatBytes(this.originalSize)}`);
        this.addLog(`   å‹ç¼©å¤§å°: ${this.formatBytes(this.compressedSize)}`);
        this.addLog(`   å‹ç¼©ç‡: ${this.compressionRatio.toFixed(1)}%`);
        this.addLog(`   ä½ç½®: ${outputFileName}`);
        this.addLog('========================================');
        this.statusText = `âœ… ${modeText}.${format} å‹ç¼©æˆåŠŸ`;
        
        promptAction.showToast({ 
          message: `${modeText}.${format} å‹ç¼©æˆåŠŸï¼`, 
          duration: 2000 
        });
      } else {
        this.addLog(`âŒ å‹ç¼©å¤±è´¥: ${result.message}`);
        this.statusText = 'å‹ç¼©å¤±è´¥';
      }
      
    } catch (error) {
      this.addLog(`âŒ å¼‚å¸¸: ${JSON.stringify(error)}`);
      this.statusText = 'å‹ç¼©å¤±è´¥';
    } finally {
      this.isRunning = false;
      this.progress = 0;
    }
  }
  
  // ç©ºæ–‡ä»¶å¤¹æµ‹è¯•
  private async testEmptyFolder(format: '7z' | 'zip') {
    if (this.isRunning) return;
    
    this.isRunning = true;
    this.progress = 0;
    this.compressionRatio = 0;
    this.originalSize = 0;
    this.compressedSize = 0;
    this.fileCount = 0;
    this.logText = '';
    
    const outputFileName = `empty_folder.${format}`;
    const outputPath = `${this.filesDir}/${outputFileName}`;
    
    // æ›´æ–°æ˜¾ç¤ºè·¯å¾„
    const emptyFolder = `${this.filesDir}/empty_test_folder`;
    this.currentInputPath = emptyFolder;
    this.currentOutputPath = outputPath;
    
    this.addLog('========================================');
    this.addLog(`ğŸ“‚ å¼€å§‹ç©ºæ–‡ä»¶å¤¹.${format} å‹ç¼©æµ‹è¯•`);
    this.addLog('========================================');
    this.statusText = `æµ‹è¯•ç©ºæ–‡ä»¶å¤¹.${format} ä¸­...`;
    
    try {
      // åˆ›å»ºç©ºæ–‡ä»¶å¤¹
      this.addLog('ğŸ“ æ­¥éª¤1: åˆ›å»ºç©ºæ–‡ä»¶å¤¹...');
      await TestFileGenerator.createDirectory(emptyFolder);
      this.addLog(`   âœ“ ç©ºæ–‡ä»¶å¤¹åˆ›å»ºå®Œæˆ: ${emptyFolder}`);
      
      // å‹ç¼©ç©ºæ–‡ä»¶å¤¹
      this.addLog(`ğŸ“¦ æ­¥éª¤2: å‹ç¼©ç©ºæ–‡ä»¶å¤¹ä¸º ${format} æ ¼å¼...`);
      this.addLog(`   è¾“å‡º: ${outputFileName}`);
      
      this.compressController = compressItems(
        [emptyFolder],
        outputPath,
        { format: format, compressionLevel: 5 },
        (prog: CompressProgress) => {
          this.progress = prog.percentage;
          this.statusText = `å‹ç¼©ä¸­ ${prog.percentage}%`;
          if (prog.percentage % 20 === 0 && prog.percentage > 0) {
            this.addLog(`   å‹ç¼©è¿›åº¦: ${prog.percentage}%`);
          }
        }
      );
      
      const result = await this.compressController.promise;
      this.compressController = null;
      
      if (result.success) {
        this.originalSize = result.originalSize || 0;
        this.compressedSize = result.compressedSize || 0;
        this.compressionRatio = result.compressionRatio || 0;
        this.fileCount = result.fileCount || 0;
        
        this.addLog('========================================');
        this.addLog(`âœ… ç©ºæ–‡ä»¶å¤¹.${format} å‹ç¼©æˆåŠŸï¼`);
        this.addLog(`   æ ¼å¼: ${result.format}`);
        this.addLog(`   æ–‡ä»¶æ•°: ${this.fileCount}`);
        this.addLog(`   å‹ç¼©å¤§å°: ${this.formatBytes(this.compressedSize)}`);
        this.addLog(`   ä½ç½®: ${outputFileName}`);
        this.addLog('========================================');
        this.statusText = `âœ… ç©ºæ–‡ä»¶å¤¹.${format} å‹ç¼©æˆåŠŸ`;
        
        promptAction.showToast({ 
          message: `ç©ºæ–‡ä»¶å¤¹.${format} å‹ç¼©æˆåŠŸï¼`, 
          duration: 2000 
        });
      } else {
        this.addLog(`âŒ å‹ç¼©å¤±è´¥: ${result.message}`);
        this.statusText = 'å‹ç¼©å¤±è´¥';
      }
      
    } catch (error) {
      this.addLog(`âŒ å¼‚å¸¸: ${JSON.stringify(error)}`);
      this.statusText = 'å‹ç¼©å¤±è´¥';
    } finally {
      this.isRunning = false;
      this.progress = 0;
    }
  }
  
  // å–æ¶ˆå‹ç¼©
  private cancelCompress() {
    if (!this.compressController) {
      this.addLog('âš ï¸  æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„å‹ç¼©ä»»åŠ¡');
      return;
    }
    
    this.addLog(`ğŸ›‘ æ­£åœ¨å–æ¶ˆå‹ç¼©ä»»åŠ¡...`);
    const success = this.compressController.cancel();
    
    if (success) {
      this.addLog('âœ… å–æ¶ˆè¯·æ±‚å·²å‘é€');
      this.statusText = 'æ­£åœ¨å–æ¶ˆ...';
    } else {
      this.addLog('âš ï¸  å–æ¶ˆå¤±è´¥ï¼ˆä»»åŠ¡å¯èƒ½å·²å®Œæˆï¼‰');
    }
  }
  
  private formatBytes(bytes: number): string {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
  }

  build() {
    Scroll() {
      Column() {
        // è¿”å›æŒ‰é’®
        Button('â† è¿”å›ä¸»èœå•')
          .fontSize(14)
          .backgroundColor('#E0E0E0')
          .fontColor('#333333')
          .height(40)
          .margin({ bottom: 20 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/MainMenu' }).catch((err: Error) => {
              this.addLog(`å¯¼èˆªå¤±è´¥: ${err.message}`);
            });
          })
        
        // æ ‡é¢˜
        Text('å‹ç¼©æµ‹è¯•')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 5 })
        
        Text('æ”¯æŒ zip / 7z å‹ç¼©')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ bottom: 20 })

        // ==================== è·¯å¾„ä¿¡æ¯æ˜¾ç¤º ====================
        Column() {
          Text('å½“å‰è·¯å¾„ä¿¡æ¯')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Column() {
            Row() {
              Text('è¾“å…¥æ–‡ä»¶:')
                .fontSize(13)
                .fontWeight(FontWeight.Bold)
                .fontColor('#666666')
                .width(80)
              
              Text(this.currentInputPath)
                .fontSize(12)
                .fontFamily('monospace')
                .fontColor('#333333')
                .layoutWeight(1)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .margin({ bottom: 8 })
            .alignItems(VerticalAlign.Top)
            
            Row() {
              Text('è¾“å‡ºæ–‡ä»¶:')
                .fontSize(13)
                .fontWeight(FontWeight.Bold)
                .fontColor('#666666')
                .width(80)
              
              Text(this.currentOutputPath)
                .fontSize(12)
                .fontFamily('monospace')
                .fontColor('#333333')
                .layoutWeight(1)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .alignItems(VerticalAlign.Top)
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#FFFFFF')
          .border({ width: 1, color: '#DDDDDD', radius: 5 })
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#F9F9F9')
        .border({ width: 1, color: '#CCCCCC', radius: 8 })
        .margin({ bottom: 25 })

        // ==================== å‹ç¼©æµ‹è¯• ====================
        Column() {
          Text('å‹ç¼©æµ‹è¯•')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 15 })
            .alignSelf(ItemAlign.Start)
          
          Text('åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¹¶å‹ç¼©ä¸ºå¯¹åº”æ ¼å¼')
            .fontSize(13)
            .fontColor('#666666')
            .margin({ bottom: 15 })
            .alignSelf(ItemAlign.Start)
          
          // Zip æ ¼å¼
          Text('ğŸ“¦ Zip æ ¼å¼')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('å•æ–‡ä»¶')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .backgroundColor('#00BCD4')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.createAndCompress('zip', 'single');
              })
            
            Button('å¤šæ–‡ä»¶')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#0097A7')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.createAndCompress('zip', 'multi');
              })
            
            Button('æ–‡ä»¶å¤¹')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#00838F')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.createAndCompress('zip', 'folder');
              })
          }
          .width('100%')
          .margin({ bottom: 15 })
          
          // 7z æ ¼å¼
          Text('ğŸ“¦ 7z æ ¼å¼')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('å•æ–‡ä»¶')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .backgroundColor('#9C27B0')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.createAndCompress('7z', 'single');
              })
            
            Button('å¤šæ–‡ä»¶')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#673AB7')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.createAndCompress('7z', 'multi');
              })
            
            Button('æ–‡ä»¶å¤¹')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#4A148C')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.createAndCompress('7z', 'folder');
              })
          }
          .width('100%')
          .margin({ bottom: 15 })
          
          // ç©ºæ–‡ä»¶å¤¹æµ‹è¯•
          Text('ğŸ“‚ ç©ºæ–‡ä»¶å¤¹æµ‹è¯•')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('ç©ºæ–‡ä»¶å¤¹.zip')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .backgroundColor('#FF9800')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.testEmptyFolder('zip');
              })
            
            Button('ç©ºæ–‡ä»¶å¤¹.7z')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#F57C00')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.testEmptyFolder('7z');
              })
          }
          .width('100%')
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#E8F5E9')
        .border({ width: 2, color: '#4CAF50', radius: 10 })
        .margin({ bottom: 25 })

        // ==================== è¿›åº¦å’Œæ§åˆ¶ ====================
        if (this.isRunning) {
          Column() {
            Row() {
              Text('å‹ç¼©è¿›åº¦')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .layoutWeight(1)
              
              Button('ğŸ›‘ å–æ¶ˆ')
                .height(35)
                .fontSize(14)
                .backgroundColor('#F44336')
                .fontColor('#FFFFFF')
                .onClick(() => {
                  this.cancelCompress();
                })
            }
            .width('100%')
            .margin({ bottom: 10 })
            
            Progress({ value: this.progress, total: 100, type: ProgressType.Linear })
              .width('100%')
              .color('#FF9800')
              .margin({ bottom: 10 })
            
            Row() {
              Text(`${this.progress}%`)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF9800')
              
              Text('ğŸ”„ å‹ç¼©ä¸­...')
                .fontSize(14)
                .fontColor('#FF9800')
                .margin({ left: 'auto' })
            }
            .width('100%')
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#FFF3E0')
          .border({ width: 1, color: '#FF9800', radius: 8 })
          .margin({ bottom: 20 })
        }

        // ==================== å‹ç¼©ç»Ÿè®¡ ====================
        if (this.compressionRatio > 0) {
          Column() {
            Text('å‹ç¼©ç»Ÿè®¡')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 15 })
              .alignSelf(ItemAlign.Start)
            
            Row() {
              Column() {
                Text('æ–‡ä»¶æ•°é‡')
                  .fontSize(12)
                  .fontColor('#666666')
                Text(`${this.fileCount}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 5 })
              }
              .layoutWeight(1)
              
              Column() {
                Text('åŸå§‹å¤§å°')
                  .fontSize(12)
                  .fontColor('#666666')
                Text(this.formatBytes(this.originalSize))
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 5 })
              }
              .layoutWeight(1)
              
              Text('â†’')
                .fontSize(20)
                .fontColor('#999999')
                .margin({ left: 5, right: 5 })
              
              Column() {
                Text('å‹ç¼©å')
                  .fontSize(12)
                  .fontColor('#666666')
                Text(this.formatBytes(this.compressedSize))
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#4CAF50')
                  .margin({ top: 5 })
              }
              .layoutWeight(1)
              
              Column() {
                Text('å‹ç¼©ç‡')
                  .fontSize(12)
                  .fontColor('#666666')
                Text(`${this.compressionRatio.toFixed(1)}%`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FF9800')
                  .margin({ top: 5 })
              }
              .layoutWeight(1)
            }
            .width('100%')
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#E8F5E9')
          .border({ width: 1, color: '#4CAF50', radius: 8 })
          .margin({ bottom: 20 })
        }

        // ==================== çŠ¶æ€ä¿¡æ¯ ====================
        Text('çŠ¶æ€')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 10 })
          .alignSelf(ItemAlign.Start)

        Text(this.statusText)
          .width('100%')
          .fontSize(14)
          .padding(12)
          .backgroundColor('#F5F5F5')
          .border({ width: 1, color: '#DDDDDD', radius: 8 })
          .margin({ bottom: 20 })

        // ==================== è¯¦ç»†æ—¥å¿— ====================
        Text('æ—¥å¿—')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 10 })
          .alignSelf(ItemAlign.Start)

        Scroll() {
          Text(this.logText || 'ç­‰å¾…æ“ä½œ...')
            .width('100%')
            .fontSize(12)
            .fontFamily('monospace')
            .textAlign(TextAlign.Start)
            .padding(10)
        }
        .width('100%')
        .height(250)
        .backgroundColor('#F5F5F5')
        .border({ width: 1, color: '#DDDDDD', radius: 8 })
      }
      .width('100%')
      .padding(20)
    }
    .width('100%')
    .height('100%')
  }
}
