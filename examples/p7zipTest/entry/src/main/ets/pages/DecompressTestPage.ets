import { Unzip, DecompressProgress, DecompressResult } from '../utils/Unzip';
import { compressItems, CompressProgress, CompressResult, CompressTaskController } from '../utils/Compress';
import { hilog } from '@kit.PerformanceAnalysisKit';
import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { TestFileGenerator } from '../utils/TestFileGenerator';
import promptAction from '@ohos.promptAction';
import fs from '@ohos.file.fs';

const DOMAIN = 0x0000;

@Entry
@Component
struct DecompressTestPage {
  private context = getContext(this) as common.UIAbilityContext;
  private filesDir: string = '';
  private compressController: CompressTaskController | null = null;
  
  // æ–‡ä»¶åˆ›å»ºç›¸å…³çŠ¶æ€
  @State createProgress: number = 0;
  @State isCreatingFiles: boolean = false;
  @State createStatusText: string = 'æœªåˆ›å»º';
  
  // å‹ç¼©ç›¸å…³çŠ¶æ€ (ç”¨äºåˆ›å»ºæµ‹è¯•å‹ç¼©åŒ…)
  @State compressProgress: number = 0;
  @State isCompressing: boolean = false;
  @State compressStatusText: string = 'æœªå‹ç¼©';
  
  // è§£å‹ç›¸å…³çŠ¶æ€
  @State decompressProgress: number = 0;
  @State statusText: string = 'è¯·é€‰æ‹©æ“ä½œ';
  @State logText: string = '';
  @State isDecompressing: boolean = false;
  @State extractedFiles: string[] = [];
  
  // è·¯å¾„æ˜¾ç¤º
  @State inputPathDisplay: string = 'æœªé€‰æ‹©';
  @State outputPathDisplay: string = 'æœªç”Ÿæˆ';
  
  // å·²åˆ›å»ºçš„æ–‡ä»¶è·¯å¾„
  private createdFiles: Map<string, string[]> = new Map();
  private createdArchives: Map<string, string> = new Map();

  aboutToAppear() {
    this.filesDir = this.context.filesDir;
    this.addLog(`âœ“ åº”ç”¨ç›®å½•: ${this.filesDir}`);
    this.addLog(`ğŸ’¡ æ“ä½œæµç¨‹: â‘ åˆ›å»ºæ–‡ä»¶ â†’ â‘¡åˆ›å»ºå‹ç¼©åŒ… â†’ â‘¢è§£å‹æµ‹è¯•`);
  }

  private addLog(message: string) {
    const time = new Date().toLocaleTimeString();
    this.logText = `[${time}] ${message}\n${this.logText}`;
    hilog.info(DOMAIN, 'DecompressTest', message);
  }
  
  // æ­¥éª¤1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶
  private async createTestFiles(mode: 'single' | 'multi') {
    if (this.isCreatingFiles) return;
    
    this.isCreatingFiles = true;
    this.createProgress = 0;
    this.createStatusText = 'åˆ›å»ºä¸­...';
    
    const modeText = mode === 'single' ? 'å•æ–‡ä»¶' : 'å¤šæ–‡ä»¶';
    this.addLog('========================================');
    this.addLog(`ğŸ“ åˆ›å»º ${modeText} æµ‹è¯•æ–‡ä»¶`);
    this.addLog('========================================');
    
    try {
      let inputPaths: string[] = [];
      let totalSteps = 0;
      let currentStep = 0;
      
      if (mode === 'single') {
        totalSteps = 1;
        const singleFile = `${this.filesDir}/test_5mb.txt`;
        this.addLog(`   åˆ›å»º: test_5mb.txt (5MB)`);
        this.createProgress = 20;
        
        await TestFileGenerator.createTestTextFileWithSize(singleFile, 5 * 1024);
        this.createProgress = 100;
        
        inputPaths = [singleFile];
        this.inputPathDisplay = singleFile;
        this.addLog(`   âœ“ å•æ–‡ä»¶åˆ›å»ºå®Œæˆ`);
      } else {
        totalSteps = 8;
        this.addLog(`   åˆ›å»º: å¤šä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å° 10MB+`);
        
        const file1 = `${this.filesDir}/large_file1.txt`;
        this.createProgress = 5;
        this.addLog(`   åˆ›å»ºfile1 (3MB)...`);
        await TestFileGenerator.createTestTextFileWithSize(file1, 3 * 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const file2 = `${this.filesDir}/large_file2.txt`;
        this.addLog(`   åˆ›å»ºfile2 (4MB)...`);
        await TestFileGenerator.createTestTextFileWithSize(file2, 4 * 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const file3 = `${this.filesDir}/large_file3.txt`;
        this.addLog(`   åˆ›å»ºfile3 (3MB)...`);
        await TestFileGenerator.createTestTextFileWithSize(file3, 3 * 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const dir1 = `${this.filesDir}/dir1`;
        await TestFileGenerator.createDirectory(dir1);
        this.addLog(`   åˆ›å»ºç›®å½•dir1...`);
        currentStep++;
        
        await TestFileGenerator.createTestTextFileWithSize(`${dir1}/file_a.txt`, 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        await TestFileGenerator.createTestTextFileWithSize(`${dir1}/file_b.txt`, 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const dir2 = `${this.filesDir}/dir2`;
        await TestFileGenerator.createDirectory(dir2);
        this.addLog(`   åˆ›å»ºç›®å½•dir2...`);
        await TestFileGenerator.createTestTextFileWithSize(`${dir2}/data.txt`, 2 * 1024);
        currentStep++;
        this.createProgress = Math.floor((currentStep / totalSteps) * 100);
        
        const subdir = `${dir2}/subdir`;
        await TestFileGenerator.createDirectory(subdir);
        await TestFileGenerator.createTestTextFileWithSize(`${subdir}/nested.txt`, 1024);
        currentStep++;
        this.createProgress = 100;
        
        inputPaths = [file1, file2, file3, dir1, dir2];
        this.inputPathDisplay = `large_file1.txt, large_file2.txt, large_file3.txt + 2ä¸ªç›®å½•`;
        this.addLog(`   âœ“ å¤šæ–‡ä»¶åˆ›å»ºå®Œæˆ`);
      }
      
      // ä¿å­˜åˆ›å»ºçš„æ–‡ä»¶è·¯å¾„
      this.createdFiles.set(mode, inputPaths);
      this.createStatusText = `âœ… ${modeText}å·²åˆ›å»º`;
      
      this.addLog(`âœ… ${modeText} æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼`);
      this.addLog('========================================');
      
      promptAction.showToast({ 
        message: `${modeText}åˆ›å»ºå®Œæˆï¼`, 
        duration: 2000 
      });
      
    } catch (error) {
      this.addLog(`âŒ åˆ›å»ºå¤±è´¥: ${JSON.stringify(error)}`);
      this.createStatusText = 'åˆ›å»ºå¤±è´¥';
    } finally {
      this.isCreatingFiles = false;
      this.createProgress = 0;
    }
  }
  
  // æ­¥éª¤2: åˆ›å»ºå‹ç¼©åŒ…
  private async createArchive(format: '7z' | 'zip', mode: 'single' | 'multi') {
    if (this.isCompressing) return;
    
    // æ£€æŸ¥æ˜¯å¦å·²åˆ›å»ºæ–‡ä»¶
    const inputPaths = this.createdFiles.get(mode);
    if (!inputPaths || inputPaths.length === 0) {
      promptAction.showToast({ 
        message: 'è¯·å…ˆåˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼', 
        duration: 2000 
      });
      this.addLog(`âš ï¸  è¯·å…ˆç‚¹å‡»"åˆ›å»ºæ–‡ä»¶"æŒ‰é’®`);
      return;
    }
    
    this.isCompressing = true;
    this.compressProgress = 0;
    
    const modeText = mode === 'single' ? 'å•æ–‡ä»¶' : 'å¤šæ–‡ä»¶';
    const outputFileName = `${mode}_output.${format}`;
    const outputPath = `${this.filesDir}/${outputFileName}`;
    this.outputPathDisplay = outputPath;
    
    this.addLog('========================================');
    this.addLog(`ğŸ“¦ åˆ›å»º ${modeText}.${format} å‹ç¼©åŒ…`);
    this.addLog('========================================');
    this.compressStatusText = `å‹ç¼©ä¸­...`;
    
    try {
      this.compressController = compressItems(
        inputPaths,
        outputPath,
        { format: format, compressionLevel: 5 },
        (prog: CompressProgress) => {
          this.compressProgress = prog.percentage;
          this.compressStatusText = `å‹ç¼©ä¸­ ${prog.percentage}%`;
          if (prog.percentage % 20 === 0 && prog.percentage > 0) {
            this.addLog(`   è¿›åº¦: ${prog.percentage}%`);
          }
        }
      );
      
      const result = await this.compressController.promise;
      this.compressController = null;
      
      if (result.success) {
        // ä¿å­˜å‹ç¼©åŒ…è·¯å¾„
        const archiveKey = `${mode}_${format}`;
        this.createdArchives.set(archiveKey, outputPath);
        
        this.addLog(`âœ… ${modeText}.${format} å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸï¼`);
        this.addLog(`   æ–‡ä»¶æ•°: ${result.fileCount}`);
        this.addLog(`   å‹ç¼©ç‡: ${result.compressionRatio?.toFixed(1)}%`);
        this.addLog('========================================');
        this.compressStatusText = `âœ… ${modeText}.${format}å·²åˆ›å»º`;
        
        promptAction.showToast({ 
          message: `å‹ç¼©åŒ…åˆ›å»ºå®Œæˆï¼`, 
          duration: 2000 
        });
      } else {
        this.addLog(`âŒ å‹ç¼©å¤±è´¥: ${result.message}`);
        this.compressStatusText = 'å‹ç¼©å¤±è´¥';
      }
      
    } catch (error) {
      this.addLog(`âŒ å¼‚å¸¸: ${JSON.stringify(error)}`);
      this.compressStatusText = 'å‹ç¼©å¤±è´¥';
    } finally {
      this.isCompressing = false;
      this.compressProgress = 0;
    }
  }
  
  // æ­¥éª¤3: è§£å‹æµ‹è¯•
  private async decompressArchive(format: '7z' | 'zip', mode: 'single' | 'multi') {
    if (this.isDecompressing) return;
    
    // æ£€æŸ¥æ˜¯å¦å·²åˆ›å»ºå‹ç¼©åŒ…
    const archiveKey = `${mode}_${format}`;
    const inputPath = this.createdArchives.get(archiveKey);
    if (!inputPath) {
      promptAction.showToast({ 
        message: 'è¯·å…ˆåˆ›å»ºå‹ç¼©åŒ…ï¼', 
        duration: 2000 
      });
      this.addLog(`âš ï¸  è¯·å…ˆç‚¹å‡»"åˆ›å»ºå‹ç¼©åŒ…"æŒ‰é’®`);
      return;
    }
    
    this.isDecompressing = true;
    this.decompressProgress = 0;
    this.extractedFiles = [];
    
    const modeText = mode === 'single' ? 'å•æ–‡ä»¶' : 'å¤šæ–‡ä»¶';
    const outputPath = `${this.filesDir}/output`;
    this.inputPathDisplay = inputPath;
    this.outputPathDisplay = outputPath;
    
    this.addLog('========================================');
    this.addLog(`ğŸš€ è§£å‹ ${modeText}.${format}`);
    this.addLog('========================================');
    this.statusText = `è§£å‹ä¸­...`;
    
    try {
      // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      const stat = fs.statSync(inputPath);
      this.addLog(`âœ“ æ–‡ä»¶å¤§å°: ${this.formatBytes(stat.size)}`);
      
      // åˆ›å»ºè§£å‹å®ä¾‹
      const unzip = new Unzip(inputPath, { overwrite: true });
      
      // è¿›åº¦ç›‘å¬
      unzip.on('start', () => {
        this.addLog('â–¶ï¸  è§£å‹å·²å¯åŠ¨');
      });
      
      unzip.on('progress', (prog: DecompressProgress) => {
        this.decompressProgress = prog.percentage;
        this.statusText = `è§£å‹ä¸­ ${prog.percentage}%`;
        if (prog.percentage % 20 === 0 && prog.percentage > 0) {
          this.addLog(`   è¿›åº¦: ${prog.percentage}%`);
        }
      });
      
      unzip.on('error', (error: Error) => {
        this.addLog(`âŒ é”™è¯¯: ${JSON.stringify(error)}`);
      });
      
      // æ‰§è¡Œè§£å‹
      const result = await unzip.decompress(outputPath);
      
      if (result.success) {
        this.extractedFiles = result.files || [];
        
        this.addLog('========================================');
        this.addLog(`âœ… ${modeText}.${format} è§£å‹æˆåŠŸï¼`);
        this.addLog(`   æ ¼å¼: ${result.format || 'æœªçŸ¥'}`);
        this.addLog(`   æ–‡ä»¶æ•°: ${this.extractedFiles.length}`);
        
        if (this.extractedFiles.length > 0 && this.extractedFiles.length <= 10) {
          this.addLog(`   æ–‡ä»¶åˆ—è¡¨:`);
          this.extractedFiles.forEach((file, index) => {
            this.addLog(`      ${index + 1}. ${file}`);
          });
        } else if (this.extractedFiles.length > 10) {
          this.addLog(`   (å…± ${this.extractedFiles.length} ä¸ªæ–‡ä»¶)`);
        }
        
        this.addLog('========================================');
        this.statusText = `âœ… è§£å‹æˆåŠŸ`;
        
        promptAction.showToast({ 
          message: `è§£å‹æˆåŠŸï¼`, 
          duration: 2000 
        });
      } else {
        this.addLog(`âŒ è§£å‹å¤±è´¥: ${result.message}`);
        this.statusText = 'è§£å‹å¤±è´¥';
      }
      
    } catch (error) {
      this.addLog(`âŒ å¼‚å¸¸: ${JSON.stringify(error)}`);
      this.statusText = 'è§£å‹å¤±è´¥';
    } finally {
      this.isDecompressing = false;
      this.decompressProgress = 0;
    }
  }
  
  private formatBytes(bytes: number): string {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
  }

  build() {
    Scroll() {
      Column() {
        // è¿”å›æŒ‰é’®
        Button('â† è¿”å›ä¸»èœå•')
          .fontSize(14)
          .backgroundColor('#E0E0E0')
          .fontColor('#333333')
          .height(40)
          .margin({ bottom: 20 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/MainMenu' }).catch((err: Error) => {
              this.addLog(`å¯¼èˆªå¤±è´¥: ${err.message}`);
            });
          })
        
        // æ ‡é¢˜
        Text('è§£å‹æµ‹è¯•')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 5 })
        
        Text('æ­¥éª¤ï¼šâ‘ åˆ›å»ºæ–‡ä»¶ â†’ â‘¡åˆ›å»ºå‹ç¼©åŒ… â†’ â‘¢è§£å‹')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ bottom: 20 })

        // ==================== è·¯å¾„ä¿¡æ¯æ˜¾ç¤º ====================
        Column() {
          Text('è·¯å¾„ä¿¡æ¯')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          // è¾“å…¥è·¯å¾„
          Column() {
            Row() {
              Text('è¾“å…¥:')
                .fontSize(13)
                .fontWeight(FontWeight.Bold)
                .fontColor('#666666')
                .width(50)
              
              Text(this.inputPathDisplay)
                .fontSize(12)
                .fontFamily('monospace')
                .fontColor('#333333')
                .layoutWeight(1)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .margin({ bottom: 8 })
            .alignItems(VerticalAlign.Top)
            
            // è¾“å‡ºè·¯å¾„
            Row() {
              Text('è¾“å‡º:')
                .fontSize(13)
                .fontWeight(FontWeight.Bold)
                .fontColor('#666666')
                .width(50)
              
              Text(this.outputPathDisplay)
                .fontSize(12)
                .fontFamily('monospace')
                .fontColor('#333333')
                .layoutWeight(1)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .alignItems(VerticalAlign.Top)
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#FFFFFF')
          .border({ width: 1, color: '#DDDDDD', radius: 5 })
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#F9F9F9')
        .border({ width: 1, color: '#CCCCCC', radius: 8 })
        .margin({ bottom: 20 })

        // ==================== æ­¥éª¤1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶ ====================
        Column() {
          Text('æ­¥éª¤1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Text('åˆ›å»ºæµ‹è¯•æ–‡ä»¶ç”¨äºåç»­å‹ç¼©')
            .fontSize(13)
            .fontColor('#666666')
            .margin({ bottom: 15 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('åˆ›å»ºå•æ–‡ä»¶(5MB)')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .backgroundColor('#4CAF50')
              .enabled(!this.isCreatingFiles)
              .onClick(() => {
                this.createTestFiles('single');
              })
            
            Button('åˆ›å»ºå¤šæ–‡ä»¶(10MB)')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#2196F3')
              .enabled(!this.isCreatingFiles)
              .onClick(() => {
                this.createTestFiles('multi');
              })
          }
          .width('100%')
          .margin({ bottom: 10 })
          
          // æ–‡ä»¶åˆ›å»ºè¿›åº¦
          if (this.isCreatingFiles) {
            Column() {
              Progress({ value: this.createProgress, total: 100, type: ProgressType.Linear })
                .width('100%')
                .color('#4CAF50')
                .margin({ bottom: 5 })
              
              Text(`${this.createProgress}% - æ­£åœ¨åˆ›å»º...`)
                .fontSize(12)
                .fontColor('#4CAF50')
            }
            .width('100%')
            .padding(10)
            .backgroundColor('#E8F5E9')
            .border({ width: 1, color: '#4CAF50', radius: 5 })
            .margin({ bottom: 10 })
          }
          
          Text(`çŠ¶æ€: ${this.createStatusText}`)
            .fontSize(13)
            .padding(8)
            .width('100%')
            .backgroundColor('#F5F5F5')
            .border({ width: 1, color: '#DDDDDD', radius: 5 })
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#F0F8FF')
        .border({ width: 2, color: '#2196F3', radius: 10 })
        .margin({ bottom: 20 })

        // ==================== æ­¥éª¤2: åˆ›å»ºå‹ç¼©åŒ… ====================
        Column() {
          Text('æ­¥éª¤2: åˆ›å»ºå‹ç¼©åŒ…')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Text('å°†å·²åˆ›å»ºçš„æ–‡ä»¶å‹ç¼©æˆå‹ç¼©åŒ…')
            .fontSize(13)
            .fontColor('#666666')
            .margin({ bottom: 15 })
            .alignSelf(ItemAlign.Start)
          
          // Zip æ ¼å¼
          Text('ğŸ“¦ Zip æ ¼å¼')
            .fontSize(15)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 8 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('å•æ–‡ä»¶.zip')
              .layoutWeight(1)
              .height(45)
              .fontSize(14)
              .backgroundColor('#00BCD4')
              .enabled(!this.isCompressing)
              .onClick(() => {
                this.createArchive('zip', 'single');
              })
            
            Button('å¤šæ–‡ä»¶.zip')
              .layoutWeight(1)
              .height(45)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#0097A7')
              .enabled(!this.isCompressing)
              .onClick(() => {
                this.createArchive('zip', 'multi');
              })
          }
          .width('100%')
          .margin({ bottom: 12 })
          
          // 7z æ ¼å¼
          Text('ğŸ“¦ 7z æ ¼å¼')
            .fontSize(15)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 8 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('å•æ–‡ä»¶.7z')
              .layoutWeight(1)
              .height(45)
              .fontSize(14)
              .backgroundColor('#9C27B0')
              .enabled(!this.isCompressing)
              .onClick(() => {
                this.createArchive('7z', 'single');
              })
            
            Button('å¤šæ–‡ä»¶.7z')
              .layoutWeight(1)
              .height(45)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#673AB7')
              .enabled(!this.isCompressing)
              .onClick(() => {
                this.createArchive('7z', 'multi');
              })
          }
          .width('100%')
          .margin({ bottom: 10 })
          
          // å‹ç¼©è¿›åº¦
          if (this.isCompressing) {
            Column() {
              Progress({ value: this.compressProgress, total: 100, type: ProgressType.Linear })
                .width('100%')
                .color('#FF9800')
                .margin({ bottom: 5 })
              
              Text(`${this.compressProgress}% - ${this.compressStatusText}`)
                .fontSize(12)
                .fontColor('#FF9800')
            }
            .width('100%')
            .padding(10)
            .backgroundColor('#FFF3E0')
            .border({ width: 1, color: '#FF9800', radius: 5 })
            .margin({ bottom: 10 })
          }
          
          Text(`çŠ¶æ€: ${this.compressStatusText}`)
            .fontSize(13)
            .padding(8)
            .width('100%')
            .backgroundColor('#F5F5F5')
            .border({ width: 1, color: '#DDDDDD', radius: 5 })
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#FFF9E6')
        .border({ width: 2, color: '#FF9800', radius: 10 })
        .margin({ bottom: 20 })

        // ==================== æ­¥éª¤3: å¼€å§‹è§£å‹ ====================
        Column() {
          Text('æ­¥éª¤3: å¼€å§‹è§£å‹')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Text('è§£å‹å·²åˆ›å»ºçš„å‹ç¼©åŒ…')
            .fontSize(13)
            .fontColor('#666666')
            .margin({ bottom: 15 })
            .alignSelf(ItemAlign.Start)
          
          // Zip æ ¼å¼
          Text('ğŸ“¦ Zip æ ¼å¼')
            .fontSize(15)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 8 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('è§£å‹å•æ–‡ä»¶.zip')
              .layoutWeight(1)
              .height(45)
              .fontSize(14)
              .backgroundColor('#4CAF50')
              .enabled(!this.isDecompressing)
              .onClick(() => {
                this.decompressArchive('zip', 'single');
              })
            
            Button('è§£å‹å¤šæ–‡ä»¶.zip')
              .layoutWeight(1)
              .height(45)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#388E3C')
              .enabled(!this.isDecompressing)
              .onClick(() => {
                this.decompressArchive('zip', 'multi');
              })
          }
          .width('100%')
          .margin({ bottom: 12 })
          
          // 7z æ ¼å¼
          Text('ğŸ“¦ 7z æ ¼å¼')
            .fontSize(15)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 8 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('è§£å‹å•æ–‡ä»¶.7z')
              .layoutWeight(1)
              .height(45)
              .fontSize(14)
              .backgroundColor('#FF9800')
              .enabled(!this.isDecompressing)
              .onClick(() => {
                this.decompressArchive('7z', 'single');
              })
            
            Button('è§£å‹å¤šæ–‡ä»¶.7z')
              .layoutWeight(1)
              .height(45)
              .fontSize(14)
              .margin({ left: 8 })
              .backgroundColor('#F57C00')
              .enabled(!this.isDecompressing)
              .onClick(() => {
                this.decompressArchive('7z', 'multi');
              })
          }
          .width('100%')
          .margin({ bottom: 10 })
          
          // è§£å‹è¿›åº¦
          if (this.isDecompressing) {
            Column() {
              Progress({ value: this.decompressProgress, total: 100, type: ProgressType.Linear })
                .width('100%')
                .color('#4CAF50')
                .margin({ bottom: 5 })
              
              Text(`${this.decompressProgress}% - ${this.statusText}`)
                .fontSize(12)
                .fontColor('#4CAF50')
            }
            .width('100%')
            .padding(10)
            .backgroundColor('#E8F5E9')
            .border({ width: 1, color: '#4CAF50', radius: 5 })
            .margin({ bottom: 10 })
          }
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#E8F5E9')
        .border({ width: 2, color: '#4CAF50', radius: 10 })
        .margin({ bottom: 20 })

        // ==================== è§£å‹æ–‡ä»¶åˆ—è¡¨ ====================
        if (this.extractedFiles.length > 0) {
          Column() {
            Text(`è§£å‹æ–‡ä»¶ (${this.extractedFiles.length})`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 10 })
              .alignSelf(ItemAlign.Start)

            Scroll() {
              Column() {
                ForEach(this.extractedFiles, (file: string, index: number) => {
                  Text(`${index + 1}. ${file}`)
                    .fontSize(11)
                    .fontFamily('monospace')
                    .width('100%')
                    .padding({ top: 2, bottom: 2 })
                })
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .padding(8)
            }
            .width('100%')
            .height(100)
            .backgroundColor('#FFFFFF')
            .border({ width: 1, color: '#4CAF50', radius: 5 })
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#E8F5E9')
          .border({ width: 1, color: '#4CAF50', radius: 8 })
          .margin({ bottom: 20 })
        }

        // ==================== è¯¦ç»†æ—¥å¿— ====================
        Text('æ“ä½œæ—¥å¿—')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 8 })
          .alignSelf(ItemAlign.Start)

        Scroll() {
          Text(this.logText || 'ç­‰å¾…æ“ä½œ...')
            .width('100%')
            .fontSize(11)
            .fontFamily('monospace')
            .textAlign(TextAlign.Start)
            .padding(8)
        }
        .width('100%')
        .height(200)
        .backgroundColor('#F5F5F5')
        .border({ width: 1, color: '#DDDDDD', radius: 8 })
      }
      .width('100%')
      .padding(20)
    }
    .width('100%')
    .height('100%')
  }
}
