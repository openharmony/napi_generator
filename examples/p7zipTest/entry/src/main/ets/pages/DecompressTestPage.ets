import { Unzip, DecompressProgress, DecompressResult } from '../utils/Unzip';
import { compressItems, CompressProgress, CompressResult, CompressTaskController } from '../utils/Compress';
import { hilog } from '@kit.PerformanceAnalysisKit';
import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { TestFileGenerator } from '../utils/TestFileGenerator';
import promptAction from '@ohos.promptAction';
import fs from '@ohos.file.fs';

const DOMAIN = 0x0000;

@Entry
@Component
struct DecompressTestPage {
  private context = getContext(this) as common.UIAbilityContext;
  private filesDir: string = '';
  private compressController: CompressTaskController | null = null;
  
  @State progress: number = 0;
  @State statusText: string = 'è¯·é€‰æ‹©æ“ä½œ';
  @State logText: string = '';
  @State isRunning: boolean = false;
  @State extractedFiles: string[] = [];
  @State currentInputPath: string = 'æœªé€‰æ‹©';
  @State currentOutputPath: string = 'æœªé€‰æ‹©';

  aboutToAppear() {
    this.filesDir = this.context.filesDir;
    this.addLog(`âœ“ åº”ç”¨ç›®å½•: ${this.filesDir}`);
  }

  private addLog(message: string) {
    const time = new Date().toLocaleTimeString();
    this.logText = `[${time}] ${message}\n${this.logText}`;
    hilog.info(DOMAIN, 'DecompressTest', message);
  }
  
  // åˆ›å»ºæµ‹è¯•å‹ç¼©åŒ…ï¼ˆåŒ…å«åˆ›å»ºæ–‡ä»¶å’Œå‹ç¼©ï¼‰
  private async createAndCompress(format: '7z' | 'zip', mode: 'single' | 'multi') {
    if (this.isRunning) return;
    
    this.isRunning = true;
    this.progress = 0;
    this.extractedFiles = [];
    this.logText = '';
    
    const modeText = mode === 'single' ? 'å•æ–‡ä»¶' : 'å¤šæ–‡ä»¶';
    const outputFileName = `${mode}_output.${format}`;
    const outputPath = `${this.filesDir}/${outputFileName}`;
    
    // æ›´æ–°æ˜¾ç¤ºè·¯å¾„
    this.currentOutputPath = outputPath;
    
    this.addLog('========================================');
    this.addLog(`ğŸ”§ å¼€å§‹åˆ›å»º ${modeText}.${format} æµ‹è¯•å‹ç¼©åŒ…`);
    this.addLog('========================================');
    this.statusText = `åˆ›å»º ${modeText}.${format} ä¸­...`;
    
    try {
      // ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼ˆè‡³å°‘5MBï¼‰
      this.addLog('ğŸ“ æ­¥éª¤1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼ˆ5MB+ï¼‰...');
      
      let inputPaths: string[] = [];
      
      if (mode === 'single') {
        // å•æ–‡ä»¶æ¨¡å¼ï¼šåˆ›å»ºä¸€ä¸ª 5MB çš„æ–‡ä»¶
        const singleFile = `${this.filesDir}/test_5mb.txt`;
        this.addLog(`   åˆ›å»º: test_5mb.txt (5MB)`);
        await TestFileGenerator.createTestBinaryFile(singleFile, 5 * 1024); // 5MB = 5120KB
        inputPaths = [singleFile];
        this.currentInputPath = singleFile;
        this.addLog(`   âœ“ å•æ–‡ä»¶åˆ›å»ºå®Œæˆ: 5MB`);
      } else {
        // å¤šæ–‡ä»¶æ¨¡å¼ï¼šåˆ›å»ºå¤šä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å°è¶…è¿‡5MB
        this.addLog(`   åˆ›å»º: å¤šä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å° 10MB+`);
        
        // åˆ›å»º3ä¸ªå¤§æ–‡ä»¶
        const file1 = `${this.filesDir}/large_file1.txt`;
        await TestFileGenerator.createTestBinaryFile(file1, 3 * 1024); // 3MB
        
        const file2 = `${this.filesDir}/large_file2.txt`;
        await TestFileGenerator.createTestBinaryFile(file2, 4 * 1024); // 4MB
        
        const file3 = `${this.filesDir}/large_file3.txt`;
        await TestFileGenerator.createTestBinaryFile(file3, 3 * 1024); // 3MB
        
        // åˆ›å»ºæ–‡ä»¶å¤¹ç»“æ„
        const dir1 = `${this.filesDir}/dir1`;
        await TestFileGenerator.createDirectory(dir1);
        await TestFileGenerator.createTestBinaryFile(`${dir1}/file_a.bin`, 1024); // 1MB
        await TestFileGenerator.createTestBinaryFile(`${dir1}/file_b.bin`, 1024); // 1MB
        
        const dir2 = `${this.filesDir}/dir2`;
        await TestFileGenerator.createDirectory(dir2);
        await TestFileGenerator.createTestBinaryFile(`${dir2}/data.bin`, 2 * 1024); // 2MB
        
        const subdir = `${dir2}/subdir`;
        await TestFileGenerator.createDirectory(subdir);
        await TestFileGenerator.createTestBinaryFile(`${subdir}/nested.bin`, 1024); // 1MB
        
        inputPaths = [file1, file2, file3, dir1, dir2];
        this.currentInputPath = `large_file1.txt, large_file2.txt, ... (å…±5é¡¹)`;
        this.addLog(`   âœ“ å¤šæ–‡ä»¶åˆ›å»ºå®Œæˆ: 3ä¸ªæ–‡ä»¶(10MB) + 2ä¸ªæ–‡ä»¶å¤¹(5MB)`);
      }
      
      this.addLog(`âœ… æµ‹è¯•æ–‡ä»¶åˆ›å»ºæˆåŠŸ`);
      
      // ç¬¬äºŒæ­¥ï¼šå‡†å¤‡å‹ç¼©
      this.addLog(`ğŸ“¦ æ­¥éª¤2: å‹ç¼©ä¸º ${format} æ ¼å¼...`);
      this.addLog(`   è¾“å‡º: ${outputFileName}`);
      
      // ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œå‹ç¼©
      this.compressController = compressItems(
        inputPaths,
        outputPath,
        { format: format, compressionLevel: 5 },
        (prog: CompressProgress) => {
          this.progress = prog.percentage;
          this.statusText = `å‹ç¼©ä¸­ ${prog.percentage}%`;
          if (prog.percentage % 20 === 0 && prog.percentage > 0) {
            this.addLog(`   å‹ç¼©è¿›åº¦: ${prog.percentage}%`);
          }
        }
      );
      
      const compressResult = await this.compressController.promise;
      this.compressController = null;
      
      if (compressResult.success) {
        this.addLog('========================================');
        this.addLog(`âœ… ${modeText}.${format} å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸï¼`);
        this.addLog(`   æ–‡ä»¶æ•°: ${compressResult.fileCount}`);
        this.addLog(`   å‹ç¼©ç‡: ${compressResult.compressionRatio?.toFixed(1)}%`);
        this.addLog(`   ä½ç½®: ${outputFileName}`);
        this.addLog('========================================');
        this.statusText = `âœ… ${modeText}.${format} åˆ›å»ºæˆåŠŸ`;
        
        promptAction.showToast({ 
          message: `${modeText}.${format} åˆ›å»ºæˆåŠŸï¼`, 
          duration: 2000 
        });
      } else {
        this.addLog(`âŒ å‹ç¼©å¤±è´¥: ${compressResult.message}`);
        this.statusText = 'å‹ç¼©å¤±è´¥';
      }
      
    } catch (error) {
      this.addLog(`âŒ å¼‚å¸¸: ${JSON.stringify(error)}`);
      this.statusText = 'åˆ›å»ºå¤±è´¥';
    } finally {
      this.isRunning = false;
      this.progress = 0;
    }
  }
  
  // è§£å‹æµ‹è¯•
  private async decompressTest(format: '7z' | 'zip', mode: 'single' | 'multi') {
    if (this.isRunning) return;
    
    this.isRunning = true;
    this.progress = 0;
    this.extractedFiles = [];
    this.logText = '';
    
    const modeText = mode === 'single' ? 'å•æ–‡ä»¶' : 'å¤šæ–‡ä»¶';
    const inputFile = `${mode}_output.${format}`;
    const inputPath = `${this.filesDir}/${inputFile}`;
    const outputPath = `${this.filesDir}/output`;
    
    // æ›´æ–°æ˜¾ç¤ºè·¯å¾„
    this.currentInputPath = inputPath;
    this.currentOutputPath = outputPath;
    
    this.addLog('========================================');
    this.addLog(`ğŸš€ å¼€å§‹è§£å‹ ${modeText}.${format}`);
    this.addLog('========================================');
    this.addLog(`ğŸ“¦ è¾“å…¥: ${inputFile}`);
    this.addLog(`ğŸ“ è¾“å‡º: output/`);
    this.statusText = `è§£å‹ ${modeText}.${format} ä¸­...`;
    
    try {
      // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      const stat = fs.statSync(inputPath);
      this.addLog(`âœ“ æ–‡ä»¶å¤§å°: ${this.formatBytes(stat.size)}`);
      
      // åˆ›å»ºè§£å‹å®ä¾‹
      const unzip = new Unzip(inputPath, { overwrite: true });
      
      // è¿›åº¦ç›‘å¬
      unzip.on('start', () => {
        this.addLog('â–¶ï¸  è§£å‹å·²å¯åŠ¨');
      });
      
      unzip.on('progress', (prog: DecompressProgress) => {
        this.progress = prog.percentage;
        this.statusText = `è§£å‹ä¸­ ${prog.percentage}%`;
        if (prog.percentage % 20 === 0 && prog.percentage > 0) {
          this.addLog(`   è§£å‹è¿›åº¦: ${prog.percentage}%`);
        }
      });
      
      unzip.on('error', (error: Error) => {
        this.addLog(`âŒ é”™è¯¯: ${JSON.stringify(error)}`);
      });
      
      // æ‰§è¡Œè§£å‹
      const result = await unzip.decompress(outputPath);
      
      if (result.success) {
        this.extractedFiles = result.files || [];
        
        this.addLog('========================================');
        this.addLog(`âœ… ${modeText}.${format} è§£å‹æˆåŠŸï¼`);
        this.addLog(`   æ ¼å¼: ${result.format || 'æœªçŸ¥'}`);
        this.addLog(`   æ–‡ä»¶æ•°: ${this.extractedFiles.length}`);
        
        if (this.extractedFiles.length > 0 && this.extractedFiles.length <= 10) {
          this.addLog(`   æ–‡ä»¶åˆ—è¡¨:`);
          this.extractedFiles.forEach((file, index) => {
            this.addLog(`      ${index + 1}. ${file}`);
          });
        } else if (this.extractedFiles.length > 10) {
          this.addLog(`   (å…± ${this.extractedFiles.length} ä¸ªæ–‡ä»¶)`);
        }
        
        this.addLog('========================================');
        this.statusText = `âœ… ${modeText}.${format} è§£å‹æˆåŠŸ`;
        
        promptAction.showToast({ 
          message: `${modeText}.${format} è§£å‹æˆåŠŸï¼`, 
          duration: 2000 
        });
      } else {
        this.addLog('========================================');
        this.addLog(`âŒ è§£å‹å¤±è´¥: ${result.message}`);
        this.statusText = 'è§£å‹å¤±è´¥';
      }
      
    } catch (error) {
      this.addLog('========================================');
      this.addLog(`âŒ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºå‹ç¼©åŒ…`);
      this.addLog(`   è·¯å¾„: ${inputPath}`);
      this.statusText = 'æ–‡ä»¶ä¸å­˜åœ¨';
    } finally {
      this.isRunning = false;
      this.progress = 0;
    }
  }
  
  private formatBytes(bytes: number): string {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
  }

  build() {
    Scroll() {
      Column() {
        // è¿”å›æŒ‰é’®
        Button('â† è¿”å›ä¸»èœå•')
          .fontSize(14)
          .backgroundColor('#E0E0E0')
          .fontColor('#333333')
          .height(40)
          .margin({ bottom: 20 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/MainMenu' }).catch((err: Error) => {
              this.addLog(`å¯¼èˆªå¤±è´¥: ${err.message}`);
            });
          })
        
        // æ ‡é¢˜
        Text('è§£å‹æµ‹è¯•')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 5 })
        
        Text('æ”¯æŒ 7z / Zip / rar / tar / gzç­‰æ ¼å¼ï¼Œå½“å‰æµ‹è¯•ç”¨ä¾‹ä»…è¦†ç›–7z/zip, è‹¥æƒ³è¿›è¡Œå…¶ä»–æ ¼å¼è§£å‹æµ‹è¯•ï¼Œå¯å°†å¾…è§£å‹çš„æ–‡ä»¶æ¨é€è‡³å¼€å‘æ¿æŒ‡å®šä½ç½®è§£å‹')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ bottom: 20 })

        // ==================== è·¯å¾„ä¿¡æ¯æ˜¾ç¤º ====================
        Column() {
          Text('å½“å‰è·¯å¾„ä¿¡æ¯')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Column() {
            Row() {
              Text('è¾“å…¥æ–‡ä»¶:')
                .fontSize(13)
                .fontWeight(FontWeight.Bold)
                .fontColor('#666666')
                .width(80)
              
              Text(this.currentInputPath)
                .fontSize(12)
                .fontFamily('monospace')
                .fontColor('#333333')
                .layoutWeight(1)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .margin({ bottom: 8 })
            .alignItems(VerticalAlign.Top)
            
            Row() {
              Text('è¾“å‡ºç›®å½•:')
                .fontSize(13)
                .fontWeight(FontWeight.Bold)
                .fontColor('#666666')
                .width(80)
              
              Text(this.currentOutputPath)
                .fontSize(12)
                .fontFamily('monospace')
                .fontColor('#333333')
                .layoutWeight(1)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .alignItems(VerticalAlign.Top)
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#FFFFFF')
          .border({ width: 1, color: '#DDDDDD', radius: 5 })
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#F9F9F9')
        .border({ width: 1, color: '#CCCCCC', radius: 8 })
        .margin({ bottom: 25 })

        // ==================== ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆ›å»ºæµ‹è¯•æ–‡ä»¶ ====================
        Column() {
          Text('1ï¸âƒ£ åˆ›å»ºæµ‹è¯•æ–‡ä»¶')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 15 })
            .alignSelf(ItemAlign.Start)
          
          Text('åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¹¶å‹ç¼©ä¸ºå¯¹åº”æ ¼å¼')
            .fontSize(13)
            .fontColor('#666666')
            .margin({ bottom: 15 })
            .alignSelf(ItemAlign.Start)
          
          // Zip æ ¼å¼
          Text('ğŸ“¦ Zip æ ¼å¼')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('å•æ–‡ä»¶.zip')
              .layoutWeight(1)
              .height(50)
              .fontSize(15)
              .backgroundColor('#00BCD4')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.createAndCompress('zip', 'single');
              })
            
            Button('å¤šæ–‡ä»¶.zip')
              .layoutWeight(1)
              .height(50)
              .fontSize(15)
              .margin({ left: 10 })
              .backgroundColor('#0097A7')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.createAndCompress('zip', 'multi');
              })
          }
          .width('100%')
          .margin({ bottom: 15 })
          
          // 7z æ ¼å¼
          Text('ğŸ“¦ 7z æ ¼å¼')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('å•æ–‡ä»¶.7z')
              .layoutWeight(1)
              .height(50)
              .fontSize(15)
              .backgroundColor('#9C27B0')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.createAndCompress('7z', 'single');
              })
            
            Button('å¤šæ–‡ä»¶.7z')
              .layoutWeight(1)
              .height(50)
              .fontSize(15)
              .margin({ left: 10 })
              .backgroundColor('#673AB7')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.createAndCompress('7z', 'multi');
              })
          }
          .width('100%')
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#E3F2FD')
        .border({ width: 2, color: '#2196F3', radius: 10 })
        .margin({ bottom: 25 })

        // ==================== ç¬¬äºŒéƒ¨åˆ†ï¼šå¼€å§‹è§£å‹ ====================
        Column() {
          Text('2ï¸âƒ£ å¼€å§‹è§£å‹')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 15 })
            .alignSelf(ItemAlign.Start)
          
          Text('è§£å‹å·²åˆ›å»ºçš„å‹ç¼©åŒ…')
            .fontSize(13)
            .fontColor('#666666')
            .margin({ bottom: 15 })
            .alignSelf(ItemAlign.Start)
          
          // Zip æ ¼å¼
          Text('ğŸ“¦ Zip æ ¼å¼')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('è§£å‹å•æ–‡ä»¶.zip')
              .layoutWeight(1)
              .height(50)
              .fontSize(15)
              .backgroundColor('#4CAF50')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.decompressTest('zip', 'single');
              })
            
            Button('è§£å‹å¤šæ–‡ä»¶.zip')
              .layoutWeight(1)
              .height(50)
              .fontSize(15)
              .margin({ left: 10 })
              .backgroundColor('#388E3C')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.decompressTest('zip', 'multi');
              })
          }
          .width('100%')
          .margin({ bottom: 15 })
          
          // 7z æ ¼å¼
          Text('ğŸ“¦ 7z æ ¼å¼')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)
          
          Row() {
            Button('è§£å‹å•æ–‡ä»¶.7z')
              .layoutWeight(1)
              .height(50)
              .fontSize(15)
              .backgroundColor('#FF9800')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.decompressTest('7z', 'single');
              })
            
            Button('è§£å‹å¤šæ–‡ä»¶.7z')
              .layoutWeight(1)
              .height(50)
              .fontSize(15)
              .margin({ left: 10 })
              .backgroundColor('#F57C00')
              .enabled(!this.isRunning)
              .onClick(() => {
                this.decompressTest('7z', 'multi');
              })
          }
          .width('100%')
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#E8F5E9')
        .border({ width: 2, color: '#4CAF50', radius: 10 })
        .margin({ bottom: 25 })

        // ==================== è¿›åº¦æ˜¾ç¤º ====================
        if (this.isRunning) {
          Column() {
            Progress({ value: this.progress, total: 100, type: ProgressType.Linear })
              .width('100%')
              .color('#FF9800')
              .margin({ bottom: 10 })
            
            Row() {
              Text(`${this.progress}%`)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF9800')
              
              Text('ğŸ”„ å¤„ç†ä¸­...')
                .fontSize(14)
                .fontColor('#FF9800')
                .margin({ left: 'auto' })
            }
            .width('100%')
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#FFF3E0')
          .border({ width: 1, color: '#FF9800', radius: 8 })
          .margin({ bottom: 20 })
        }

        // ==================== çŠ¶æ€ä¿¡æ¯ ====================
        Text('çŠ¶æ€')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 10 })
          .alignSelf(ItemAlign.Start)

        Text(this.statusText)
          .width('100%')
          .fontSize(14)
          .padding(12)
          .backgroundColor('#F5F5F5')
          .border({ width: 1, color: '#DDDDDD', radius: 8 })
          .margin({ bottom: 20 })

        // ==================== è§£å‹æ–‡ä»¶åˆ—è¡¨ ====================
        if (this.extractedFiles.length > 0) {
          Text(`è§£å‹æ–‡ä»¶ (${this.extractedFiles.length})`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
            .alignSelf(ItemAlign.Start)

          Scroll() {
            Column() {
              ForEach(this.extractedFiles, (file: string, index: number) => {
                Text(`${index + 1}. ${file}`)
                  .fontSize(12)
                  .fontFamily('monospace')
                  .width('100%')
                  .padding({ top: 3, bottom: 3 })
              })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
            .padding(10)
          }
          .width('100%')
          .height(120)
          .backgroundColor('#E8F5E9')
          .border({ width: 1, color: '#4CAF50', radius: 8 })
          .margin({ bottom: 20 })
        }

        // ==================== è¯¦ç»†æ—¥å¿— ====================
        Text('æ—¥å¿—')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 10 })
          .alignSelf(ItemAlign.Start)

        Scroll() {
          Text(this.logText || 'ç­‰å¾…æ“ä½œ...')
            .width('100%')
            .fontSize(12)
            .fontFamily('monospace')
            .textAlign(TextAlign.Start)
            .padding(10)
        }
        .width('100%')
        .height(250)
        .backgroundColor('#F5F5F5')
        .border({ width: 1, color: '#DDDDDD', radius: 8 })
      }
      .width('100%')
      .padding(20)
    }
    .width('100%')
    .height('100%')
  }
}
