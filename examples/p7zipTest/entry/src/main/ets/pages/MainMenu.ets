import router from '@ohos.router';
import { hilog } from '@kit.PerformanceAnalysisKit';
import common from '@ohos.app.ability.common';
import { TestFileGenerator, CreateResult } from '../utils/TestFileGenerator';
import promptAction from '@ohos.promptAction';

const DOMAIN = 0x0000;

@Entry
@Component
struct MainMenu {
  @State appVersion: string = 'v1.0.0';
  @State isCreatingFiles: boolean = false;
  private context = getContext(this) as common.UIAbilityContext;

  private navigateTo(url: string, title: string) {
    router.pushUrl({
      url: url
    }).then(() => {
      hilog.info(DOMAIN, 'MainMenu', `å¯¼èˆªåˆ°: ${title}`);
    }).catch((err: Error) => {
      hilog.error(DOMAIN, 'MainMenu', `å¯¼èˆªå¤±è´¥: ${err.message}`);
    });
  }

  // åˆ›å»ºæµ‹è¯•æ–‡ä»¶
  private async createTestFiles() {
    if (this.isCreatingFiles) {
      return;
    }
    
    this.isCreatingFiles = true;
    
    try {
      promptAction.showToast({
        message: 'æ­£åœ¨åˆ›å»ºæµ‹è¯•æ–‡ä»¶...',
        duration: 2000
      });
      
      const filesDir = this.context.filesDir;
      hilog.info(DOMAIN, 'MainMenu', `æ–‡ä»¶ç›®å½•: ${filesDir}`);
      
      const result = await TestFileGenerator.createCompleteTestEnv(filesDir);
      
      if (result.success) {
        promptAction.showDialog({
          title: 'âœ“ æµ‹è¯•æ–‡ä»¶åˆ›å»ºæˆåŠŸ',
          message: `${result.message}\n\næ–‡ä»¶ä½ç½®ï¼š\n${filesDir}\n\nç°åœ¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è·¯å¾„è¿›è¡Œæµ‹è¯•ï¼š\n\nå•æ–‡ä»¶ï¼štest.txt\nå¤šæ–‡ä»¶ï¼šfile1.txt, file2.txt, file3.txt\næ–‡ä»¶å¤¹ï¼šdir1ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰, dir2ï¼ˆ2æ–‡ä»¶+1åµŒå¥—æ–‡ä»¶å¤¹ï¼‰\nç›®å½•å‹ç¼©ï¼š${filesDir}/mydir`,
          buttons: [{ text: 'çŸ¥é“äº†', color: '#2196F3' }]
        });
      } else {
        promptAction.showDialog({
          title: 'åˆ›å»ºå¤±è´¥',
          message: result.message,
          buttons: [{ text: 'ç¡®å®š', color: '#FF0000' }]
        });
      }
    } catch (error) {
      hilog.error(DOMAIN, 'MainMenu', `åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¤±è´¥: ${error}`);
      promptAction.showDialog({
        title: 'é”™è¯¯',
        message: `åˆ›å»ºå¤±è´¥: ${error}`,
        buttons: [{ text: 'ç¡®å®š', color: '#FF0000' }]
      });
    } finally {
      this.isCreatingFiles = false;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
      Column() {
        Text('å‹ç¼©è§£å‹å·¥å…·')
          .fontSize(36)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .margin({ top: 40 })

        Text(this.appVersion)
          .fontSize(14)
          .fontColor('#FFFFFF')
          .opacity(0.7)
          .margin({ top: 5 })
      }
      .width('100%')
      .height(150)
      .backgroundColor('#2196F3')
      .justifyContent(FlexAlign.Center)

      // åŠŸèƒ½èœå•åŒºåŸŸ
      Scroll() {
        Column() {
          Text('é€‰æ‹©åŠŸèƒ½')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 30, bottom: 20 })
            .alignSelf(ItemAlign.Start)

          // è§£å‹åŠŸèƒ½å¡ç‰‡
          Column() {
            Row() {
              Text('ğŸ“¦')
                .fontSize(48)
                .margin({ right: 20 })

              Column() {
                Text('è§£å‹ç¼©')
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .alignSelf(ItemAlign.Start)

                Text('æ”¯æŒ LZMA / 7z / Zip / Tar / RAR ç­‰å¤šç§æ ¼å¼')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ top: 5 })
                  .alignSelf(ItemAlign.Start)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
            }
            .width('100%')
            .padding(20)
          }
          .width('100%')
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({ radius: 8, color: '#1F000000', offsetX: 0, offsetY: 2 })
          .onClick(() => {
            this.navigateTo('pages/DecompressTestPage', 'è§£å‹åŠŸèƒ½');
          })
          .margin({ bottom: 20 })

          // å‹ç¼©åŠŸèƒ½å¡ç‰‡
          Column() {
            Row() {
              Text('ğŸ—œï¸')
                .fontSize(48)
                .margin({ right: 20 })

              Column() {
                Text('å‹ç¼©')
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .alignSelf(ItemAlign.Start)

                Text('å•æ–‡ä»¶ / å¤šæ–‡ä»¶ / æ–‡ä»¶å¤¹å‹ç¼©ï¼Œæ”¯æŒ 7z å’Œ Zip')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ top: 5 })
                  .alignSelf(ItemAlign.Start)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
            }
            .width('100%')
            .padding(20)
          }
          .width('100%')
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({ radius: 8, color: '#1F000000', offsetX: 0, offsetY: 2 })
          .onClick(() => {
            this.navigateTo('pages/CompressTestPage', 'å‹ç¼©åŠŸèƒ½');
          })
          .margin({ bottom: 20 })

          // åŠŸèƒ½ç‰¹æ€§åˆ—è¡¨
          Column() {
            Text('åŠŸèƒ½ç‰¹æ€§')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 30, bottom: 15 })
              .alignSelf(ItemAlign.Start)

            Column() {
              this.FeatureItem('âœ…', 'å¤šæ ¼å¼æ”¯æŒ', 'æ”¯æŒä¸»æµå‹ç¼©æ ¼å¼')
              Divider().margin({ left: 40 })
              this.FeatureItem('âœ…', 'å¤§æ–‡ä»¶å¤„ç†', 'è‡ªåŠ¨åˆ†å—ï¼Œå†…å­˜å®‰å…¨')
              Divider().margin({ left: 40 })
              this.FeatureItem('âœ…', 'å®æ—¶è¿›åº¦', 'æ˜¾ç¤ºå‹ç¼©/è§£å‹è¿›åº¦')
              Divider().margin({ left: 40 })
              this.FeatureItem('âœ…', 'æ‰¹é‡æ“ä½œ', 'æ”¯æŒå¤šæ–‡ä»¶å’Œæ–‡ä»¶å¤¹')
              Divider().margin({ left: 40 })
              this.FeatureItem('ğŸ†•', 'å®Œå–„é”™è¯¯å¤„ç†', 'ç£ç›˜ç©ºé—´æ£€æŸ¥ã€è¯¦ç»†é”™è¯¯ç ')
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(15)
            .shadow({ radius: 8, color: '#1F000000', offsetX: 0, offsetY: 2 })
          }
          .width('100%')

          // åº•éƒ¨ä¿¡æ¯
          Column() {
            Text('åŸºäº p7zip å’Œ LZMA SDK')
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 30 })

            Text('HarmonyOS Native å¼€å‘')
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 5 })
          }
          .margin({ top: 20, bottom: 20 })
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 20, right: 20 })
        .backgroundColor('#F5F5F5')
      }
      .width('100%')
      .height(600)
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  FeatureItem(icon: string, title: string, description: string) {
    Row() {
      Text(icon)
        .fontSize(24)
        .margin({ right: 15 })
      
      Column() {
        Text(title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .alignSelf(ItemAlign.Start)
        
        Text(description)
          .fontSize(13)
          .fontColor('#666666')
          .margin({ top: 2 })
          .alignSelf(ItemAlign.Start)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: 12, bottom: 12 })
  }
}

